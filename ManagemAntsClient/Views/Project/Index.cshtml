@{
    Layout = "~/Views/Shared/_Navbar.cshtml";
}
@model ManagemAntsClient.Models.ProjectPage


<div>
    <nav class="navbar py-0 bg-blue shadow">
        <a href="@Url.Action("Index", "Dashboard")" class="navbar-brand text-white">Accueil</a>
        <span class="navbar-text text-white">@Model.Project.name</span>
        <span class="navbar-text text-white">
          <button class="btn btn-danger btn-sm mr-2">Deconnexion</button>
               @Model.LoggedUser.pseudo
        </span>
    </nav>
    <div class="row no-gutters justify-content-around">
        <div class="col-8 shadow bg-lightgray p-2 m-3">
            <div class="row mt-2">
                <div class="col-3 align-self-center">
                    <div class="row">
                        <div class="dropdown col-auto">
                            <a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                            </a>

                            <div class="dropdown-menu" id="taskFilters" belaria-laledby="dropdownMenuLink">
                                <a class="dropdown-item btn">A faire</a>
                                <a class="dropdown-item btn">En cours</a>
                                <a class="dropdown-item btn">Fait</a>
                                <a class="dropdown-item btn">Rendu</a>
                                <a class="dropdown-item btn">Pas de filtre</a>
                            </div>
                        </div>
                        <div class="form-check align-self-center ml-2">
                            @if (!Model.isMyTasks)
                            {
                                <input class="form-check-input" type="checkbox" value="false" id="myTasks" />
                            }
                            else
                            {
                                <input class="form-check-input" type="checkbox" value="true" id="myTasks" checked/>
                            }
                            <label class="form-check-label" for="flexCheckDefault">
                                Mes Taches
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-5 text-center"><h3>Todo List</h3></div>
                <div class="col-4 text-right align-self-center">
                    <button onclick="openTaskAdd()" class="btn btn-secondary btn-sm text-sm-center ">Ajouter une tache</button>
                </div>
            </div>
            <div class="p-3">
                @foreach (var task in Model.Tasks)
                {
                    <div class="row bg-dark rounded mb-2 p-2">
                        <div class="col-auto mr-auto text-white align-self-center pl-1">
                            <button class="btn btn-sm btn-secondary mr-1 bg-transparent noBorder border-0">
                                <img class="white-img " src="~/img/edit-solid.svg" onclick="openTaskInfos(@task.id)" />
                            </button>

                            @task.name
                        </div>
                        <div class="col-auto pr-1 d-flex">
                            @if (task.state == 0)
                            {
                                <button class="btn btn-danger btn-sm" disabled>Retour</button>
                            }
                            else
                            {
                                @using (Html.BeginForm("BackStateTask", "Project", task, FormMethod.Post))
                                {
                                    <button class="btn btn-danger btn-sm">Retour</button>
                                }
                            }
                            <button class="btn btn-secondary btn-sm ml-2 mr-2" disabled>@task.getState()</button>
                            @if (task.state == 3)
                            {
                                <button class="btn btn-success btn-sm" disabled>Suivant</button>
                            }
                            else
                            {
                                @using (Html.BeginForm("NextStateTask", "Project", task, FormMethod.Post))
                                {
                                    <button class="btn btn-success btn-sm" name="suivant">Suivant</button>
                                }
                            }
                        </div>
                    </div>
                    <partial name="_taskModifyModal" model="@task" />
                    <partial name="_taskInfoModal" model="@new ManagemAntsClient.Models.InfosTask() { Task = task, LoggedUser = Model.LoggedUser }" />

                }
                <div class="row justify-content-center">
                    <button onclick="openTaskAdd()" class="btn btn-secondary btn-sm">+</button>
                </div>
            </div>
        </div>
        <div class="col-lg">
            <div class="shadow mb-4 bg-lightgray p-2 m-3">
                <div class="m-4">
                    <h3>Membres</h3>
                </div>

                <div class="m-4">
                    <h5>Créateur</h5>
                </div>
                @foreach (var collaborator in Model.Creators)
                {
                    <div class="m-4 p-2 shadow bg-collaborator">
                        @collaborator.pseudo (@collaborator.firstname @collaborator.lastname)
                    </div>
                }

                @if (Model.Mangers.Count != 0)
                {
                    <div class="m-4">
                        <h5>Manageur(s)</h5>
                    </div>
                    @foreach (var collaborator in Model.Mangers)
                    {
                        <div class="m-4 p-2 shadow bg-collaborator">
                            @collaborator.pseudo (@collaborator.firstname @collaborator.lastname)
                        </div>
                    }
                }

                @if (Model.Collaborators.Count != 0)
                {
                    <div class="m-4">
                        <h5>Collaborateur(s)</h5>
                    </div>
                    @foreach (var collaborator in Model.Collaborators)
                    {
                        <div class="m-4 p-2 shadow bg-collaborator">
                            @collaborator.pseudo (@collaborator.firstname @collaborator.lastname)
                        </div>
                    }
                }
                @if (Model.LoggedUser.role != 2)
                {
                    <div class="text-center m-4">
                        <a href="@Url.Action("Index", "AddCollaborator", new
                            {
                                projectId = Model.Project.id,
                                projectName = Model.Project.name,
                                userId = Model.LoggedUser.id
                            }) ">
                            <button type="button" class="btn btn-md btn-secondary w-100" onclick="addCollaborator()">
                                Gérer les collaborateurs
                            </button>
                        </a>
                    </div>
                }
            </div>
            <button class="btn btn-secondary btn-lg m-3">Statistiques</button>
        </div>


    </div>
</div>
<partial name="_taskAddModal"/>


<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
    window.onload = function () {
        if (@Model.OpenedTask != "-1")
            openTaskInfos(@Model.OpenedTask)
    }
 
    let searchParams = new URLSearchParams(window.location.search)
    let filter = searchParams.get("filter");
    if (filter == null)
        filter = "Filtre...";
    $("#dropdownMenuLink").text(filter);

    function openTaskInfos(id) {
        $(`#taskInfoModal-${id}`).modal("show");
    }

    function openTaskAdd() {
        $("#taskAddModal").modal("show");
    }


    $(document).ready(
        function () {
            $('#taskFilters a').on('click', function () {
                var value = $('#myTasks').val();
                var filterval = $(this).text();
                var boolValue = (value == 'true');
                var clearurl = document.location.href.split("&")[0];
                var url = clearurl + "&filter=" + filterval + "&myTasks=" + boolValue;
                document.location = url;
            }
            )
            $('#myTasks').on('click', function () {
                var filter = $('#dropdownMenuLink').text();
                var value = $('#myTasks').val();
                var boolValue = !(value == 'true');
                var clearurl = document.location.href.split("&")[0];
                var url = clearurl + "&filter=" + filter + "&myTasks=" + boolValue;
                document.location = url;
            })
        });
</script>